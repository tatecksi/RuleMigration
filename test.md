<h1>Sample Rule Mapping between ArcSight/QRadar and Azure Sentinel</h1>
<br />
<h2>ArcSight</h2>
<br />

| No. 	| Type         	| Sample Detection Rule                       	| Sample KQL 	| Reference      	|
|-----	|--------------	|---------------------------------------------	|------------	|----------------	|
| 1.   	| **Filter** (and) 	| <img src="media/caf5e11a5e0d7ed6dcc675c0caaaf7aa.png"> 	| <br/><pre><sub>SecurityEvent<br/>\| where EventID == 4728<br/>\| where SubjectUserName =~ "AutoMatedService"<br/>\| where isnotempty(SubjectDomainName)</sub></pre><sub> This assumes that the Windows Security Events are collected via MMA/AMA.<br/>Hence, we are using SecurityEvent table in Azure Sentinel.<br/><br/>**Note:** <br/> - Avoid case-insensitive operators (=~) when possible for query optimization. <br/> - Use (==) if the value is not case-sensitive.<br/> - Order the filters by starting with the 'where' statement that filter out the most data.<br/></sub> | <sub> [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[Numerical Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/numoperators)<br/>[ago](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/agofunction)<br/>[Datetime/timespan arithmetric](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datetime-timespan-arithmetic)<br/>[between](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/betweenoperator)<br/>[now](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/nowfunction)<br/> [parse](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseoperator)<br/>[extract](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/extractfunction)<br/>[parse_json](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsejsonfunction)<br/>[parse_csv](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsecsvfunction)<br/>[parse_path](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsepathfunction)<br/>[parse_url](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseurlfunction) </sub>	
| 2.    | **Filter** (or)   | <img src="media/cf7c4ef2bf29e136988353de1355bec2.png">  |<sub>***Option 1: Use 'in'***<br/><pre>SecurityEvent<br/>\| where SubjectUserName in<br/> ("Adm1","ServiceAccount1","AutomationServices")</pre><br/>***Option 2: Use 'or'***<br/><pre>SecurityEvent<br/>\| where SubjectUserName == "Adm1" or <br/>SubjectUserName == "ServiceAccount1" or <br/>SubjectUserName == "AutomationServices"</pre></sub> | <sub> [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[in](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/inoperator) </sub> 
| 3.   | **Nested Filter**  |  ![](media/e287eb056812ee240fe572a28d809393.png)<br/><br/><br/><sub>__"/All Filters/Soc Filters/Exclude Valid Users":__<sub/><br/>  ![](media/86656cdcececce6b6c45d4db3f8b15e1.png) | <sub>There are a few options to translate this in Azure Sentinel:<br/><br/>***Option 1: Direct filter with "where" statement***<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728 <br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName) <br/>\| where SubjectUserName !\~ "AutoMatedService"</pre>**Note:**<br/>Avoid case-insensitive operators (!~) when possible for query optimization. Use (!=) if the value is not case-sensitive.<br/><br/>***Option 2: Use KQL function***<br/><br/>  1. Save the following query as KQL function with the alias of “ExcludeValidUsers”.<br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>\| project SubjectUserName</pre>2. After that, use the following query to filter "ExcludeValidUsers"<br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName)<br/>\| where SubjectUserName !in (ExcludeValidUsers)</pre><br/>***Option 3: Use parameter function***<br/><br/> 1. Create a parameter function with the name and alias of “ExcludeValidUsers”.<br/>  2. Define the parameters of the function. For example,<br/><pre>Tbl: (TimeGenerated:datatime, Computer:string, EventID:string, <br/>SubjectDomainName:string, TargetDomainName:string,<br/> SubjectUserName:string)</pre>  3. The parameter function has the following query:<pre>Tbl<br/>\| where SubjectUserName !\~ "AutoMatedService"</pre> 4. Invoke the parameter function with the following query:<br/> <pre>let Events = (<br/>SecurityEvent <br/>\| where EventID == 4728<br/>);<br/>ExcludeValidUsers(Events)</pre><br/>***Option 4: Use Join***<br/><br/>Least preferred option. Avoid using 'join' when it can be done other options.<br/><pre>let events = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) <br/>or isnotempty(TargetDomainName)<br/>);<br/>let ExcludeValidUsers = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>);<br/>events<br/>\| join kind=leftanti ExcludeValidUsers on <br>\$left.SubjectUserName == \$right.SubjectUserName</pre>***Note:*** Avoid case-insensitive operators (=\~) when possible for query optimization.<sub/><br/> |<sub>  [Sample KQL function](https://techcommunity.microsoft.com/t5/azure-sentinel/using-kql-functions-to-speed-up-analysis-in-azure-sentinel/ba-p/712381)<br/>[Sample Parameter function](../../../Downloads/Enriching%20Windows%20Security%20Events%20with%20Parameterized%20Function%20-%20Microsoft%20Tech%20Community)<br/>[Join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[where](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/whereoperator)</sub>
| 4   | **Active list**  (Lookup)   | ![](media/513a09f2398d9c89d3c7499f0f54856e.png)   |<sub><pre>let Activelist=(<br/>\_GetWatchlist('Cyber-Ark Exception Accounts')<br/>\| project Account );<br/>CommonSecurityLog<br/>\| where DeviceVendor == "Cyber-Ark"<br/>\| where DeviceCustomNumber1 != ""<br/>\| where DeviceAction == "Get File Request"<br/>\| where DestinationUserName in (Activelist)<br/>\| project DeviceAction, DestinationUserName, TimeGenerated,<br/>SourceHostName, SourceUserName, DeviceEventClassID</pre><br/>\*This assumes the Watchlist 'Cyber-Ark Exception Accounts' has been created in Azure Sentinel with an Account field.<sub/> | <sub>Watchlist is the “Active list” equivalent feature in Azure Sentinel.<br/>Learn more about Watchlist with the following link:<br/><sub/>[Watchlist](https://docs.microsoft.com/en-us/azure/sentinel/watchlists)<br/><br/>However, Watchlist is just one of the methods to implement lookups and you might not need to use Watchlist all the time.<br/>Refer to the below blog post for more options:<br/>[Implementing Lookups in Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-sentinel/implementing-lookups-in-azure-sentinel/ba-p/1091306)   
  
