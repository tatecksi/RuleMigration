<h1>Sample Rule Mapping between ArcSight/QRadar and Azure Sentinel</h1>
<br />
<h2>ArcSight</h2>
<br />

| No. 	| Type         	| Sample Detection Rule                       	| Sample KQL 	| Reference      	|
|-----	|--------------	|---------------------------------------------	|------------	|----------------	|
| 1.   	| **Filter** (and) 	| <img src="media/caf5e11a5e0d7ed6dcc675c0caaaf7aa.png"> 	| <br><pre>SecurityEventSecurityEvent<br>\| where EventID == 4728<br>\| where SubjectUserName =~ "AutoMatedService"<br>\| where isnotempty(SubjectDomainName)</pre><sub> *This assumes that the Windows Security Events are collected via MMA/AMA.<br> Hence, we are using SecurityEvent table in Azure Sentinel.*<br><br>**Note:** <br> - Avoid case-insensitive operators (=~) when possible for query optimization. <br> - Use (==) if the value is not case-sensitive.<br> - Order the filters by starting with the 'where' statement that filter out the most data.</sub> | <sub> [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[Numerical Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/numoperators)<br/>[ago](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/agofunction)<br/>[Datetime/timespan arithmetric](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datetime-timespan-arithmetic)<br/>[between](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/betweenoperator)<br/>[now](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/nowfunction)<br/> [parse](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseoperator)<br/>[extract](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/extractfunction)<br/>[parse_json](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsejsonfunction)<br/>[parse_csv](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsecsvfunction)<br/>[parse_path](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsepathfunction)<br/>[parse_url](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseurlfunction) </sub>	
| 2.    | **Filter** (or)   | <img src="media/cf7c4ef2bf29e136988353de1355bec2.png">  |***Option 1: Use 'in'***<br><pre>SecurityEvent<br>\| where SubjectUserName in<br> ("Adm1","ServiceAccount1","AutomationServices")</pre><br>***Option 2: Use 'or'***<br><pre>SecurityEvent<br>\| where SubjectUserName == "Adm1" or <br>SubjectUserName == "ServiceAccount1" or <br>SubjectUserName == "AutomationServices"</pre> | <sub> [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[in](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/inoperator) </sub> 
| 3   | **Nested Filter**  |  ![](media/e287eb056812ee240fe572a28d809393.png)<br/><br/><br/>"/All Filters/Soc Filters/Exclude Valid Users":  ![](media/86656cdcececce6b6c45d4db3f8b15e1.png) | There are a few options to translate this in Azure Sentinel:<br/><br/>***Option 1: Direct filter with "where" statement***<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728 <br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName) <br/>\| where SubjectUserName !\~ "AutoMatedService"</pre><br/>***Option 2: Use KQL function***<br/><br/>  1. Save the following query as KQL function with the alias of “ExcludeValidUsers”.<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>\| project SubjectUserName</pre><br/>  2. After that, use the following query to filter "ExcludeValidUsers"<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName)<br/>\| where SubjectUserName !in (ExcludeValidUsers)</pre><br/>***Option 3: Use parameter function***<br/><br/> 1. Create a parameter function with the name and alias of “ExcludeValidUsers”.<br/>  2. Define the parameters of the function. For example,<br/><pre>Tbl: (TimeGenerated:datatime, Computer:string, EventID:string,<br> SubjectDomainName:string, TargetDomainName:string, SubjectUserName:string)</pre>  3. The parameter function has the following query:<pre>Tbl<br/>\| where SubjectUserName !\~ "AutoMatedService"</pre> 4. Invoke the parameter function with the following query:<br/><br/> <pre>let Events = (SecurityEvent \| where EventID == 4728);<br/>ExcludeValidUsers(Events)</pre><br/><br/>***Option 4: Use Join***<br/><br/><pre>let events = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName)<br/>);<br/>let ExcludeValidUsers = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService" );<br/>events<br/>\| join kind=leftanti ExcludeValidUsers on <br>\$left.SubjectUserName == \$right.SubjectUserName</pre><br/>***Note:*** Avoid case-insensitive operators (=\~) when possible for query optimization.   |<sub>  [Sample KQL function](https://techcommunity.microsoft.com/t5/azure-sentinel/using-kql-functions-to-speed-up-analysis-in-azure-sentinel/ba-p/712381)<br/>[Sample Parameter function](../../../Downloads/Enriching%20Windows%20Security%20Events%20with%20Parameterized%20Function%20-%20Microsoft%20Tech%20Community)<br/>[Join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[where](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/whereoperator)</sub>   
