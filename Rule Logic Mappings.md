<h1>Sample Rule Criteria Mapping for ArcSight/QRadar -> Azure Sentinel</h1>
<br />
<h2><u>ArcSight</u></h2>
<br />

| No. | Type | Sample Detection Rule &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Sample KQL | Reference |
|---|---|---|---|---|
| 1.  | **Filter** (and) | ![](media/caf5e11a5e0d7ed6dcc675c0caaaf7aa.png) |  <pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService" </pre>     \*This assumes that the Windows Security Events are collected via MMA/AMA. Hence, we are using SecurityEvent table in Azure Sentinel.  Note: Avoid case-insensitive operators (=\~) when possible for query optimization.  | [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[Numerical Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/numoperators)<br/>[ago](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/agofunction)<br/>[Datetime/timespan arithmetric](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datetime-timespan-arithmetic)<br/>[between](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/betweenoperator)<br/>[now](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/nowfunction)<br/> [parse](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseoperator)<br/>[extract](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/extractfunction)<br/>[parse_json](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsejsonfunction)<br/>[parse_csv](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsecsvfunction)<br/>[parse_path](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsepathfunction)<br/>[parse_url](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseurlfunction)  |
| 2   |   **Filter** (or)   |    ![](media/cf7c4ef2bf29e136988353de1355bec2.png){width=200px} |***Option 1: Use 'in'***<br/><br/><pre>SecurityEvent<br/>\| where SubjectUserName in ("Adm1","ServiceAccount1","AutomationServices")</pre><br/>***Option 2: Use 'or'***<br/><br/><pre>SecurityEvent<br/>\| where SubjectUserName == "Adm1" or SubjectUserName == "ServiceAccount1" or SubjectUserName == "AutomationServices"</pre> | [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[in](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/inoperator)    
| 3   | **Nested Filter**  |  ![](media/e287eb056812ee240fe572a28d809393.png)<br/><br/><br/>"/All Filters/Soc Filters/Exclude Valid Users":  ![](media/86656cdcececce6b6c45d4db3f8b15e1.png) | There are a few options to translate this in Azure Sentinel:<br/><br/>***Option 1: Direct filter with "where" statement***<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728 <br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName) <br/>\| where SubjectUserName !\~ "AutoMatedService"</pre><br/>***Option 2: Use KQL function***<br/><br/>  1. Save the following query as KQL function with the alias of “ExcludeValidUsers”.<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>\| project SubjectUserName</pre><br/>  2. After that, use the following query to filter "ExcludeValidUsers"<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName)<br/>\| where SubjectUserName !in (ExcludeValidUsers)</pre><br/>***Option 3: Use parameter function***<br/><br/> 1. Create a parameter function with the name and alias of “ExcludeValidUsers”.<br/>  2. Define the parameters of the function. For example,<br/><pre>Tbl: (TimeGenerated:datatime, Computer:string, EventID:string, SubjectDomainName:string, TargetDomainName:string, SubjectUserName:string)</pre>  3. The parameter function has the following query:<pre>Tbl<br/>\| where SubjectUserName !\~ "AutoMatedService"</pre> 4. Invoke the parameter function with the following query:<br/><br/> <pre>let Events = (SecurityEvent \| where EventID == 4728);<br/>ExcludeValidUsers(Events)</pre><br/><br/>***Option 4: Use Join***<br/><br/><pre>let events = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or isnotempty(TargetDomainName)<br/>);<br/>let ExcludeValidUsers = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService" );<br/>events<br/>\| join kind=leftanti ExcludeValidUsers on \$left.SubjectUserName == \$right.SubjectUserName</pre><br/>***Note:*** Avoid case-insensitive operators (=\~) when possible for query optimization.   | [Sample KQL function](https://techcommunity.microsoft.com/t5/azure-sentinel/using-kql-functions-to-speed-up-analysis-in-azure-sentinel/ba-p/712381)<br/>[Sample Parameter function](../../../Downloads/Enriching%20Windows%20Security%20Events%20with%20Parameterized%20Function%20-%20Microsoft%20Tech%20Community)<br/>[Join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[where](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/whereoperator)    |
| 4   | **Active list**  (Lookup)   | ![](media/513a09f2398d9c89d3c7499f0f54856e.png)   |<pre>let Activelist=(<br/>\_GetWatchlist('Cyber-Ark Exception Accounts')<br/>\| project Account );<br/>CommonSecurityLog<br/>\| where DeviceVendor == "Cyber-Ark"<br/>\| where DeviceCustomNumber1 != ""<br/>\| where DeviceAction == "Get File Request"<br/>\| where DestinationUserName in (Activelist)<br/>\| project DeviceAction, DestinationUserName, TimeGenerated, SourceHostName, SourceUserName, DeviceEventClassID</pre><br/>\*This assumes the Watchlist 'Cyber-Ark Exception Accounts' has been created in Azure Sentinel with an Account field. | Watchlist is the “Active list” equivalent feature in Azure Sentinel.<br/>Learn more about Watchlist with the following link:<br/>[Watchlist](https://docs.microsoft.com/en-us/azure/sentinel/watchlists)<br/><br/>However, Watchlist is just one of the methods to implement lookups and you might not need to use Watchlist all the time.<br/>Refer to the below blog post for more options:<br/>[Implementing Lookups in Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-sentinel/implementing-lookups-in-azure-sentinel/ba-p/1091306)   |
|  5  | **Correlation**  (Match a rule condition against a set of base events) |  ![](media/765de18fb4d82d41dcf5856b7cde57b4.png) |<pre>let event1 =(<br/>SecurityEvent<br/>\| where EventID == 4728 );<br/>let event2 =(<br/>SecurityEvent<br/>\| where EventID == 4729 );<br/>event1<br/>\| join kind=inner event2 on \$left.TargetUserName==\$right.TargetUserName</pre>|Join:<br/>[Join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[Time Window join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/join-timewindow)<br/>[Shuffle](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/shufflequery)<br/>[Broadcast](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/broadcastjoin) <br/>[Union](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/unionoperator?pivots=azuredataexplorer)<br/><br/>Define statement:<br/>[let](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/letstatement)<br/><br/> Aggregation:<br/>[make_set](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/makeset-aggfunction)<br/>[make_list](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/makelist-aggfunction)<br/>[make_bag](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/make-bag-aggfunction)<br/>[pack](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/packfunction)  |
| 6   | **Correlation** (Time Window Filter)  |  ![](media/765de18fb4d82d41dcf5856b7cde57b4.png) |<pre>let waittime = 10m;<br/>let lookback = 1d;<br/>let event1 = (<br/>SecurityEvent<br/>\| where TimeGenerated \> ago(waittime+lookback)<br/>\| where EventID == 4728<br/>\| project event1_time = TimeGenerated, event1_ID = EventID, event1_Activity= Activity, event1_Host = Computer, TargetUserName, event1_UPN=UserPrincipalName,AccountUsedToAdd = SubjectUserName );<br/>let event2 = (<br/>SecurityEvent<br/>\| where TimeGenerated \> ago(waittime)<br/>\| where EventID == 4729<br/>\| project event2_time = TimeGenerated, event2_ID = EventID,event2_Activity= Activity, event2_Host= Computer, TargetUserName, event2_UPN=UserPrincipalName,AccountUsedToRemove = SubjectUserName );<br/> event1<br/>\| join kind=inner event2 on TargetUserName<br/>\| where event2_time - event1_time \< lookback<br/>\| where tolong(event2_time - event1_time ) \>=0<br/>\| project delta_time = event2_time - event1_time, event1_time,event2_time, event1_ID,event2_ID,event1_Activity,event2_Activity,TargetUserName, AccountUsedToAdd,AccountUsedToRemove, event1_Host,event2_Host,event1_UPN,event2_UPN</pre>|[Join](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[Azure Sentinel Correlation Rules : Join](https://techcommunity.microsoft.com/t5/azure-sentinel/azure-sentinel-correlation-rules-the-join-kql-operator/ba-p/1041500)  |
| 7   | **Aggregation**  | ![](media/b3a52d1e5d3ef4a33a0504f94f9bf7cc.png) | <pre>SecurityEvent<br/>\| summarize Count = count() by SubjectUserName, SubjectDomainName<br/>\| where Count \>3</pre> | [summarize](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/summarizeoperator) |
| | | | | |

<br />
<br />
<br />
<br />
<h2><u>QRadar</u></h2>
<br />

| No. | Type  | Syntax example | Sample KQL | Reference |
|---|---|---|---|---|
| 1.  | Common Property Tests  | Syntax:![](media/589476c0a854f3a5987dec7782889b46.png) | See below for each statement separately | |
| | | and when any of **\<these properties\>** match **\<this regular expression\>**  Example ![](media/770315e174bd4d5a77c86448776ff601.png) |<pre>CommonSecurityLog</br>\| where tostring(SourcePort) matches regex @"\\d{1,5}" or tostring(DestinationPort) matches regex @"\\d{1,5}"</pre>|[matches regex](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/re2)|
| | | and when the event matches \<**this\>** AQL filter query  Example ![](media/c34f274ca7e8b036e98e61740590f526.png) |<pre>CommonSecurityLog</br>\| where SourceIP == '10.1.1.10'</pre>|  [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)  |
| |  | and when **\<this property\> \<equals/not equals\> \<this property\>**  Example ![](media/84e4e93c43d7123662b6d99c9fbbbc1c.png) |<pre>CommonSecurityLog</br>\| where SourceIP == DestinationIP</pre> |  [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings) |
| 2.  | Date/Time Tests        | Syntax: ![](media/99aad65913131b01281b263c1f09d942.png) | See below for each statement separately |  [Date and time operations](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/samples?pivots=azuremonitor#date-and-time-operations)   |
| | | and when the event(s) occur \<**on/after/before\>** the \<**selected\>** day of the month  Example ![](media/94a7113e83b467298b5a045bc071f49e.png) |<pre>SecurityEvent</br>\| where dayofmonth(TimeGenerated) \< 4</pre>|  [dayofmonth()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/dayofmonthfunction) |
| | | and when the event(s) occur on any of \<**these days of the week{Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday}\>**  Example ![](media/5aa6f1449a63b4e1389f5c7856463e41.png)                                                                                                                                                | <pre>SecurityEvent</br>\| where dayofweek(TimeGenerated) in (time(3),time(4),time(5))</pre>|  [dayofweek()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/dayofweekfunction) |
|  | | and when the event(s) occur \<**after/before/at\> \<this time{12.00AM, 12.05AM, ...11.50PM, 11.55PM}\>**  Example ![](media/bbc348f1e04c0edab4b4548ff039643e.png)  |<pre>SecurityEvent</br>\| where format_datetime(TimeGenerated,'HH:mm')=="23:55"</pre></br>   \*TimeGenerated is in UTC/GMT  |  [format_datetime()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/format-datetimefunction) |
| 3.  | Event property Tests   | ![](media/42c406f899f89708cf98722756821192.png)  | See below for each statement separately  | |
| | |  and when the IP protocol is one of the following **\<protocols\>** ![](media/21fae36240a914cfbdda8f8760017c6a.png)|<pre>CommonSecurityLog</br>\| where Protocol in ("UDP","ICMP")</pre>|  [String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)|
| | |  and when the Event Payload contains **\<this string**\>![](media/d9c4307d45781276cfca8101fa1620dd.png) |<pre>search "Palo Alto"</pre></br>Note: Avoid using "search" command if you already know the table name as it is not performance optimized.  |  [search()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/searchoperator?pivots=azuredataexplorer) |
| 4.  | Functions - Counters   | ![](media/ad948f1a7cd75d534888d2c4dae261a4.png)  | See below for each statement separately | |
| | |  and when at least **\<this many\>** events are seen with the same **\<event properties\>** in **\<this many\> \<minutes\>** ![](media/27530cfda836607ae0e417549db02985.png)                                                                                                                                                                 |<pre>CommonSecurityLog</br>\| summarize Count = count() by SourceIP, DestinationIP</br>\| where Count \>= 5</pre>|  [summarize](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/summarizeoperator)  |
| 5.  | Functions - Negative   | ![](media/84b0592bde1b9d5090e4a5fa8316c419.png) | See below for each statement separately   |   |
|  |  | and when none of **\<these rules\>** match in **\<this many\> \<minutes\>** after **\<these rules\>** match with the same **\<event properties\>**  ![](media/21fae36240a914cfbdda8f8760017c6a.png) ![](media/84e4e93c43d7123662b6d99c9fbbbc1c.png) Example using the rules defined above: ![](media/bf171f333debe3bd056b8fec05e8ecb1.png)   |<pre>let spanoftime = 10m;</br>let Test2 = ( CommonSecurityLog</br>\| where Protocol !in ("UDP","ICMP")</br>\| where TimeGenerated \> ago(spanoftime) );</br>let Test6 = ( CommonSecurityLog</br>\| where SourceIP == DestinationIP );</br>Test2</br>\| join kind=rightanti Test6 on \$left. SourceIP == \$right. SourceIP and \$left. Protocol ==\$right. Protocol</pre>|  [join()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>[String Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>[Numerical Operators](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/numoperators)   |
| 6.  | Functions – Simple     | ![](media/b4827844bee9f5c1b514799c54c9f360.png)  | See below for each statement separately  |  |
| || and when an event matches **\<any\|all\>** of the following **\<rules\>**  Example ![](media/7198293ebb9c16d7e7de669e31c9cc8f.png) |<pre>let Test2 = (</br>CommonSecurityLog</br>\| where Protocol !in ("UDP","ICMP") );</br>let Test6 = (</br>CommonSecurityLog</br>\| where SourceIP == DestinationIP );</br>union Test2, Test6</pre>|  [union()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/unionoperator?pivots=azuredataexplorer) |
| 7.  | IP / Port Tests  | ![](media/9298713f8003d7b3d332fc4ef8a2c25b.png) | See below for each statement separately  |  |
|  |   |  and when the source port is one of the following **\<ports\>**  Example ![](media/7bf452a3eeda48d4bc8fc940e71c6974.png)  |<pre>CommonSecurityLog</br>\| where SourcePort == 20</pre>||
|  |  |  and when the source IP is one of the following **\<IP addresses\>**  Example ![](media/218eebd9f180df1da02c4da26b50cb35.png)  |<pre>CommonSecurityLog</br>\| where SourceIP in (“10.1.1.1”,”10.2.2.2”)</pre>| |
| 8.  | Log Source Tests | ![](media/0e63f550fffa8b9694251eb38d6ac574.png) | See below for each statement separately  | |
| |  |  and when the event(s) were detected by one or more of these **\<log source types\>**  Example  ![](media/d816b66c464f4cc3574e3a3c04bc7965.jpeg) |  <pre>OfficeActivity</br>\| where OfficeWorkload == "Exchange"</pre>| |
